- hosts: exchange
  gather_facts: true
  tasks:
    - name: Create Exchange Temp directory
      win_file:
        path: c:\exchangeinstall
        state: directory
    - name: Check for file
      win_stat:
        path: c:\exchangeinstall\exchange2013.Zip
      register: zip_stat
    - name: Copy Exchange Zip
      win_copy:
        src: ../files/exchange2013.zip
        dest: c:\exchangeinstall\exchange2013.Zip
        when: zip_stat.stat.size > 0
    - name: Unzip
      win_unzip:
        src: c:\exchangeinstall\exchange2013.Zip
        dest: c:\exchangeinstall\disk
        rm: yes
    - name: Check for file for Mailboxes
      win_stat:
        path: c:\exchangeinstall\mailboxes.zip
      register: zip_stat
    - name: Copy Exchange Mailboxes
      win_copy:
        src: ../files/mailboxes.zip
        dest: c:\exchangeinstall\mailboxes.zip
        when: zip_stat.stat.size > 0
    - name: Unzip Exchange Mailboxes
      win_unzip:
        src: c:\exchangeinstall\mailboxes.Zip
        dest: c:\exchangeinstall\disk\mailboxes
        rm: yes
    - name: Check for file for Exchange Prereqs
      win_stat:
        path: c:\exchangeinstall\exchangeinstall.zip
      register: zip_stat
    - name: Copy Exchange Prereqs Zip
      win_copy:
        src: ../files/exchangeinstall.zip
        dest: c:\exchangeinstall\exchangeinstall.zip
        when: zip_stat.stat.size > 0

    - name: Unzip Exchange Prereqs
      win_unzip:
        src: c:\exchangeinstall\exchangeinstall.Zip
        dest: c:\exchangeinstall\
        rm: yes
    - name: Setup Share
      win_share:
        name: disk
        path: c:\exchangeinstall\disk
        full: Everyone
    - name: Copy Finishing script
      win_copy:
        src: ../files/Exchange-Finish.ps1
        dest: c:\exchangeinstall\Exchange-Finish.ps1
    - name: Unblock Finishing script
      win_shell: Unblock-File c:\exchangeinstall\Exchange-Finish.ps1
    - name: Install RSAT-Adds
      win_feature:
        name: RSAT-Adds
        state: present
        include_sub_features: true
        include_management_tools: true
    - name: Install Additional Features
      win_shell: Install-WindowsFeature AS-HTTP-Activation, Desktop-Experience, NET-Framework-45-Features, RPC-over-HTTP-proxy, RSAT-Clustering, RSAT-Clustering-CmdInterface, RSAT-Clustering-Mgmt, RSAT-Clustering-PowerShell, Web-Mgmt-Console, WAS-Process-Model, Web-Asp-Net45, Web-Basic-Auth, Web-Client-Auth, Web-Digest-Auth, Web-Dir-Browsing, Web-Dyn-Compression, Web-Http-Errors, Web-Http-Logging, Web-Http-Redirect, Web-Http-Tracing, Web-ISAPI-Ext
    - name: Install Additional Features Pt 2
      win_shell: Install-WindowsFeature Web-ISAPI-Filter,Web-Lgcy-Mgmt-Console,Web-Metabase, Web-Mgmt-Console, Web-Mgmt-Service, Web-Net-Ext45, Web-Request-Monitor, Web-Server, Web-Stat-Compression, Web-Static-Content, Web-Windows-Auth, Web-WMI, Windows-Identity-Foundation
    - name: Reboot System
      win_reboot:
    - name: Install KB2919442
      win_shell: Start-Process -FilePath c:\windows\system32\wusa.exe -ArgumentList "c:\exchangeinstall\Windows8.1-KB29194420x64.msu /f /quiet /norestart" -NoNewWindow -PassThru -Wait
    - name: Install KB2919355
      win_shell: Start-Process -FilePath c:\windows\system32\wusa.exe -ArgumentList "c:\exchangeinstall\Windows8.1-KB2919355-x64.msu /f /quiet /norestart" -NoNewWindow -PassThru -Wait
    - name: Install .net 461
      win_shell: c:\exchangeinstall\NDP461-KB3102436-x86-x64-AllOS-ENU.exe /q /norestart
    - name: Install KB3146715
      win_shell: Start-Process -FilePath c:\windows\system32\wusa.exe -ArgumentList "c:\exchangeinstall\Windows8.1-KB3146715-x64.msu /f /quiet /norestart" -NoNewWindow -PassThru -Wait
    - name: Install UCMA Runtime
      win_shell: c:\exchangeinstall\ucmaruntimesetup.exe /passive /norestart
    - name: Reboot before Installing Exchange
      win_reboot:
    - name: Prepare AD
      win_shell: c:\exchangeinstall\disk\setup.exe  /IAcceptExchangeServerLicenseTerms /PrepareAD /OrganizationName:MercyTechHealth
    - name: Prepare Install Exchange
      win_shell: c:\exchangeinstall\disk\setup.exe /IAcceptExchangeServerLicenseTerms /InstallWindowsComponents /roles:Mailbox,ClientAccess /DoNotStartTransport
    - name: Set Transport
      win_shell: Set-Service MSExchangeTransport -StartupType Manual
    - name: Set FrontEndTransport
      win_shell: Set-Service MSExchangeFrontEndTransport -StartupType Manual
    - name: Install Filter Pack
      win_shell: c:\exchangeinstall\FilterPack64bit.exe /passive /norestart
    - name: Install FilterPack SP1
      win_shell: c:\exchangeinstall\filterpack2010sp1-kb2460041-x64-fullfile-en-us.exe /passive /norestart
    - name: Reboot again
      win_reboot:
    - name: Run finishing script
      win_shell: c:\exchangeinstall\Exchange-Finish.ps1
